<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enregistrement Utilisateur Firestore</title>
    <!-- Chargement de Tailwind CSS pour un style rapide et moderne -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4">

    <div class="w-full max-w-3xl bg-white shadow-xl rounded-xl p-8 mt-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Mini-Site d'Enregistrement</h1>
        <p class="text-sm text-center text-red-600 bg-red-50 p-3 rounded-lg mb-6">
            ⚠️ Attention : Pour des raisons de sécurité et d'éducation, seul le pseudonyme est enregistré dans la base de données. Les mots de passe ne doivent jamais être stockés en texte clair dans une application réelle.
        </p>

        <!-- Formulaire d'Enregistrement -->
        <div class="mb-8 p-6 border border-indigo-200 rounded-lg bg-indigo-50">
            <h2 class="text-xl font-semibold text-indigo-800 mb-4">1. Enregistrer un Nouvel Utilisateur</h2>
            <form id="registrationForm" class="space-y-4">
                <div>
                    <label for="pseudo" class="block text-sm font-medium text-gray-700">Pseudonyme</label>
                    <input type="text" id="pseudo" name="pseudo" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Mot de Passe (Non enregistré)</label>
                    <input type="password" id="password" name="password" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button type="submit" id="submitButton"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Enregistrer le Pseudonyme
                </button>
            </form>
            <p id="messageArea" class="mt-4 text-center"></p>
        </div>

        <!-- Liste des Utilisateurs Enregistrés -->
        <div class="p-6 border border-gray-200 rounded-lg bg-white">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">2. Utilisateurs Enregistrés (Mise à jour en temps réel)</h2>
            <div class="mb-4 text-sm text-gray-600">
                <p>Votre ID utilisateur (anonyme) : <code id="userIdDisplay" class="font-mono text-xs bg-gray-100 p-1 rounded">Chargement...</code></p>
            </div>
            <ul id="usersList" class="space-y-2">
                <li class="text-gray-500 italic">Chargement des données...</li>
            </ul>
        </div>
    </div>

    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ATTENTION: CONFIGURATION FIREBASE À METTRE À JOUR MANUELLEMENT ---
        // Lorsque vous déployez ce code sur GitHub ou ailleurs, les variables globales (commentées ci-dessous)
        // ne sont plus disponibles. Vous DEVEZ utiliser votre propre configuration de projet Firebase.

        // 1. OBTENEZ VOTRE CONFIGURATION : Créez un projet sur la console Firebase
        //    et copiez les clés d'initialisation de votre application Web (Web app).

        // 2. MODIFIEZ L'OBJET CI-DESSOUS avec vos clés réelles.
        const firebaseConfig = {
             apiKey: "AIzaSyDokPbtOP4QgslzQ-07469fKSWi7CCGTlg",
             authDomain: "data-e1b2d.firebaseapp.com",
             projectId: "data-e1b2d", // Le 'projectId' est essentiel et était manquant !
             storageBucket: "data-e1b2d.firebasestorage.app",
             messagingSenderId: "35809352946",
             appId: "1:35809352946:web:344b2b4b163cdebc24046b"
        };
        const customAppId = "votre_app_id_pour_la_collection_github"; // Utilisé pour définir le chemin de la collection
        
        // Les lignes suivantes sont pour l'environnement Canvas uniquement et sont maintenant désactivées pour le déploiement sur GitHub.
        // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        // const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        const messageArea = document.getElementById('messageArea');
        const usersList = document.getElementById('usersList');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Fonction d'aide pour afficher les messages
        function displayMessage(message, type = 'success') {
            messageArea.textContent = message;
            messageArea.className = `mt-4 text-center p-2 rounded-md ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
        }

        // --- 1. Initialisation et Authentification Firebase ---
        try {
            // Tenter d'initialiser avec la configuration statique (votre configuration réelle)
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Sur GitHub Pages, nous allons utiliser une connexion anonyme par défaut car il n'y a pas de jeton personnalisé.
            // Le jeton personnalisé n'est plus utilisé ici.
            signInAnonymously(auth).catch(e => {
                console.error("Erreur de connexion anonyme à Firebase.", e);
                displayMessage("Erreur : Impossible de se connecter à l'authentification Firebase.", 'error');
            });


            // Gérer l'état d'authentification et les actions une fois connecté
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    userIdDisplay.textContent = userId;
                    // Lancer le chargement des données une fois authentifié
                    setupRealtimeListener();
                } else {
                    isAuthReady = false;
                    userId = null;
                    userIdDisplay.textContent = 'Non authentifié. Connexion échouée.';
                }
            });

        } catch (error) {
            console.error("Erreur lors de l'initialisation de Firebase: Veuillez vérifier si vous avez bien inséré votre configuration Firebase dans le code.", error);
            displayMessage("Erreur d'initialisation de la base de données. Avez-vous mis à jour les clés de configuration ?", 'error');
        }

        // --- 2. Fonction d'enregistrement des données ---
        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady) {
                displayMessage("Authentification en cours ou échec. Veuillez vérifier la console.", 'error');
                return;
            }

            const pseudoInput = document.getElementById('pseudo');
            const passwordInput = document.getElementById('password');
            const pseudo = pseudoInput.value.trim();
            const password = passwordInput.value;

            if (!pseudo || !password) {
                displayMessage("Veuillez remplir tous les champs.", 'error');
                return;
            }

            // Définition du chemin de la collection publique
            // NOTE : Le chemin de la collection DOIT être adapté pour votre projet GitHub,
            // d'où l'utilisation de `customAppId` pour éviter le chemin spécifique au Canvas.
            // Chemin : /github_deployments/{customAppId}/public/data/users_registrations
            const collectionPath = `github_deployments/${customAppId}/public/data/users_registrations`;
            const usersCollectionRef = collection(db, collectionPath);

            try {
                // Création de l'objet de données à enregistrer
                const newRegistration = {
                    pseudonyme: pseudo,
                    // IMPORTANT: Le mot de passe est ignoré ici.
                    enregistrePar: userId,
                    timestamp: serverTimestamp() // Ajoute l'heure du serveur
                };

                // Utilisation de addDoc pour ajouter un nouveau document
                await addDoc(usersCollectionRef, newRegistration);

                displayMessage(`Pseudonyme '${pseudo}' enregistré avec succès dans Firestore !`);
                // Réinitialiser le formulaire (sauf le mot de passe pour des raisons pratiques de test)
                pseudoInput.value = '';

            } catch (e) {
                console.error("Erreur lors de l'ajout du document:", e);
                displayMessage("Erreur lors de l'enregistrement. Voir la console pour les détails.", 'error');
            }
        });

        // --- 3. Écoute en temps réel des utilisateurs enregistrés ---
        function setupRealtimeListener() {
            if (!db || !isAuthReady) return;

            // Définition du même chemin de collection
            const collectionPath = `github_deployments/${customAppId}/public/data/users_registrations`;
            const usersCollectionRef = collection(db, collectionPath);
            const q = query(usersCollectionRef); // On peut ajouter des clauses (ex: where, orderBy) ici

            // onSnapshot écoute les changements en temps réel
            onSnapshot(q, (snapshot) => {
                usersList.innerHTML = ''; // Vider la liste actuelle
                let listContent = '';

                if (snapshot.empty) {
                    listContent = '<li class="text-gray-500 italic">Aucun utilisateur enregistré pour l\'instant.</li>';
                } else {
                    snapshot.forEach((doc) => {
                        const userData = doc.data();
                        const pseudo = userData.pseudonyme || 'N/A';
                        const docId = doc.id;
                        const savedBy = userData.enregistrePar === userId ? '(Vous)' : '';

                        listContent += `
                            <li class="flex justify-between items-center p-3 bg-gray-50 rounded-md shadow-sm border border-gray-100">
                                <span class="text-lg font-medium text-gray-800">${pseudo} ${savedBy}</span>
                                <span class="text-xs text-gray-500 font-mono">ID Doc: ${docId}</span>
                            </li>
                        `;
                    });
                }
                usersList.innerHTML = listContent;
            }, (error) => {
                console.error("Erreur lors de l'écoute en temps réel:", error);
                usersList.innerHTML = '<li class="text-red-500">Erreur lors du chargement des utilisateurs.</li>';
            });
        }
    </script>
</body>
</html>
