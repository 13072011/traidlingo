<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeLingo - Salle de March√©</title> 
    <link rel="icon" type="image/png" href="./logo.png">
    
    <style>
        /* --- 1. Variables Globales (Identiques aux autres pages) --- */
        :root {
            /* Couleurs Base (Mode Clair par d√©faut dans le CSS, g√©r√© par data-theme ici) */
            --bg-primary: #f0f4f8;
            --bg-secondary: #ffffff;
            --text-color: #333;
            --text-secondary: #666;
            --border-color: #e5e5e5;

            --green: #58a700;
            --green-dark: #468400;
            --red: #ea2b2b;
            --blue: #007bff;
            --blue-light: #d7eaff;
            --gold: #ffc107;
            --purple: #6f42c1;
            
            /* Sp√©cifique Extrade */
            --chart-height: 70vh; /* Utilise 70% de la hauteur de la vue */
        }

        /* Surcharge Mode Sombre */
        html[data-theme='dark'] {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --text-color: #f0f0f0;
            --text-secondary: #aaaaaa;
            --border-color: #333333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            margin: 0;
            padding-top: 70px; /* Espace pour le header fixe */
            padding-bottom: 70px; /* Espace pour le footer fixe */
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- 2. Header Stats (Int√©gration TradeLingo) --- */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            height: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 1000;
            box-sizing: border-box;
        }
        .stats-group { display: flex; gap: 15px; }
        .stat { font-size: 1.1rem; font-weight: bold; display: flex; align-items: center; }
        .stat span { margin-left: 5px; }
        .header-controls button {
            background: var(--bg-primary); color: var(--text-color);
            border: 2px solid var(--border-color); padding: 5px 10px;
            border-radius: 20px; cursor: pointer; font-weight: bold;
        }

        /* --- 3. Contr√¥les Graphique --- */
        .controls-container {
            width: 95%; max-width: 1200px; margin: 20px auto 10px auto;
            display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
            background: var(--bg-secondary); padding: 15px; border-radius: 10px;
            border: 2px solid var(--border-color);
        }
        .input-group { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
        .input-group label { font-weight: bold; }
        .chart-input {
            padding: 10px; border-radius: 5px; border: 2px solid var(--border-color);
            background: var(--bg-primary); color: var(--text-color); font-weight: bold;
            width: 100%; max-width: 150px;
        }
        .action-btn {
            padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;
            font-weight: bold; color: white; transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.95); }
        .btn-blue { background-color: var(--blue); }
        .btn-green { background-color: var(--green); }
        .btn-red { background-color: var(--red); }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; } /* Ajout du style small pour le bouton de r√©initialisation */

        /* --- 4. Container TradingView --- */
        .tradingview-widget-container {
            width: 95%; max-width: 1200px; height: var(--chart-height); /* UTILISE LA HAUTEUR CSS */
            margin: 0 auto; border-radius: 10px; overflow: hidden;
            border: 2px solid var(--border-color);
            background-color: var(--bg-secondary);
        }
        #tradingview_chart_widget{
            height: 100%; /* S'assure que le widget remplit son conteneur */
        }

        /* --- 5. Simulateur de Trading --- */
        #trade-simulator {
            width: 95%; max-width: 1200px; margin: 20px auto;
            background: var(--bg-secondary); padding: 20px; border-radius: 10px;
            border: 2px solid var(--border-color); box-sizing: border-box;
        }
        .sim-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-bottom: 15px;
        }
        .balance-display { font-size: 1.5rem; font-weight: bold; color: var(--gold); }
        
        .trade-controls {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;
            margin-bottom: 20px;
        }
        .trade-input-wrapper { display: flex; flex-direction: column; gap: 5px; }
        .trade-input-wrapper label { font-size: 0.85rem; color: var(--text-secondary); }
        
        /* Table des positions */
        .positions-table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { color: var(--text-secondary); font-size: 0.9rem; }
        .pl-green { color: var(--green); font-weight: bold; }
        .pl-red { color: var(--red); font-weight: bold; }
        
        /* --- 6. Footer Nav (Identique) --- */
        .footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: var(--bg-secondary);
            border-top: 2px solid var(--border-color);
            display: flex; justify-content: center; align-items: center;
            height: 50px; padding: 5px 0; z-index: 1000;
        }
        .footer-btn-group { display: flex; gap: 15px; }
        .nav-btn {
            height: 40px; width: 40px; border-radius: 10px;
            background: var(--bg-primary); color: var(--text-color);
            border: 2px solid var(--border-color); font-size: 1.2rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .nav-btn.active-page {
            background-color: var(--blue); color: white; border-color: #0056b3;
        }

    </style>
</head>
<body>

    <header class="top-bar">
        <div class="stats-group">
            <div class="stat"><span style="color:orange;">üî•</span><span id="streak-count">0</span></div>
            <div class="stat"><span style="color:skyblue;">üíé</span><span id="gem-count">0</span></div>
            <div class="stat"><span style="color:red;">‚ù§Ô∏è</span><span id="life-count">5</span></div>
        </div>
        <div class="header-controls">
            <button id="theme-toggle" onclick="toggleTheme()">üåô</button>
        </div>
    </header>

    <div class="controls-container">
        <div class="input-group">
            <label for="symbol-input">Symbole :</label>
            <input type="text" id="symbol-input" class="chart-input" value="BTCUSDT" placeholder="Ex: BTCUSDT">
            <button id="load-symbol-btn" class="action-btn btn-blue">Charger</button>
        </div>
        <div style="font-size: 0.9rem; color: var(--text-secondary);">
            Donn√©es fournies par TradingView. Prix en direct (WebSocket) : BINANCE
        </div>
    </div>

    <div class="tradingview-widget-container">
        <div id="tradingview_chart_widget"></div> 
    </div>

    <div id="trade-simulator">
        <div class="sim-header">
            <div>
                <h3>Simulateur de Trading</h3>
                <p style="margin:0; font-size:0.9rem;">Entra√Ænez-vous sans risque (Capital Virtuel)</p>
            </div>
            <!-- Changement de structure pour inclure le bouton de r√©initialisation -->
            <div style="display: flex; flex-direction: column; align-items: flex-end;"> 
                <div class="balance-display" id="sim-balance">10,000 $</div>
                <button onclick="resetSimulatorPrompt()" class="action-btn btn-blue btn-small" style="margin-top: 5px;">
                    R√©initialiser Capital
                </button>
            </div>
        </div>

        <div class="trade-controls">
             <div class="trade-input-wrapper">
                <label style="font-weight: bold; color: var(--blue);">Prix Actuel du March√©</label>
                <div id="display-current-price" style="font-size: 1.2rem; font-weight: bold;">... Connexion ...</div> 
            </div>
            <div class="trade-input-wrapper">
                <label>Quantit√© / Montant ($)</label>
                <input type="number" id="trade-amount" class="chart-input" placeholder="Ex: 1000">
            </div>
            <div class="trade-input-wrapper" style="justify-content: flex-end;">
                <button onclick="executeTrade('buy')" class="action-btn btn-green" style="width:100%">ACHETER (Long)</button>
            </div>
            <div class="trade-input-wrapper" style="justify-content: flex-end;">
                <button onclick="executeTrade('sell')" class="action-btn btn-red" style="width:100%">VENDRE (Short)</button>
            </div>
        </div>

        <div class="positions-table-container">
            <h4>Positions Ouvertes</h4>
            <table id="positions-table">
                <thead>
                    <tr>
                        <th>Symbole</th>
                        <th>Type</th>
                        <th>Entr√©e</th>
                        <th>P&L Flottant</th> 
                        <th>Taille</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="positions-body">
                    <tr><td colspan="6" style="text-align:center;">Aucune position ouverte</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <footer class="footer">
        <div class="footer-btn-group">
            <a href="index.html"><button class="nav-btn">üè†</button></a>
            <a href="page2.html"><button class="nav-btn">üìà</button></a>
            <a href="extrade.html"><button class="nav-btn active-page">üí∏</button></a>
        </div>
    </footer>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        // --- GESTION UTILISATEUR (TradeLingo) ---
        const defaultUserData = { streak: 0, gems: 100, lives: 5, progress: {} };

        function loadUserData() {
            const saved = localStorage.getItem('tradeLingoUser');
            return saved ? JSON.parse(saved) : defaultUserData;
        }

        function updateStatsUI() {
            const userData = loadUserData();
            document.getElementById('life-count').innerText = userData.lives;
            document.getElementById('gem-count').innerText = userData.gems;
            document.getElementById('streak-count').innerText = userData.streak;
        }

        // --- GESTION GRAPHIQUE & PRIX EN TEMPS R√âEL (WebSocket) ---
        let tvWidget = null;
        let currentSymbol = localStorage.getItem('lastSymbol') || "BTCUSDT"; 
        let currentPrice = 0; 
        let currentWebSocket = null; 

        function initWidget(theme, symbol) {
            const container = document.getElementById('tradingview_chart_widget');
            // Mieux vaut ne pas nettoyer le container avant de v√©rifier si le widget existe
            if (tvWidget) {
                // Si le widget existe, tentez d'utiliser son API pour changer le symbole (plus propre)
                try {
                    tvWidget.onChartReady(() => {
                        tvWidget.setSymbol(`BINANCE:${symbol}`);
                    });
                    console.log(`TradingView: Symbole chang√© via API pour BINANCE:${symbol}`);
                    return; // Sortir si le symbole a √©t√© mis √† jour
                } catch (e) {
                    console.error("Erreur lors de la mise √† jour du symbole via l'API TradingView, rechargement complet.", e);
                    container.innerHTML = ''; // Nettoyer pour recharger
                }
            } else {
                 container.innerHTML = ''; // Nettoyer si c'est la premi√®re init
            }
            
            // Rechargement complet du widget
            const tvSymbol = symbol.includes(':') ? symbol : `BINANCE:${symbol}`; 
            const toolbarBg = (theme === 'dark' ? "#1e1e1e" : "#ffffff"); 

            tvWidget = new TradingView.widget({
                "width": "100%",
                "height": "500px", 
                "symbol": tvSymbol, 
                "interval": "D",
                "timezone": "Europe/Paris",
                "theme": theme,
                "style": "1",
                "locale": "fr",
                "toolbar_bg": toolbarBg,
                "enable_publishing": false,
                "allow_symbol_change": false,
                "container_id": "tradingview_chart_widget",
                "hide_side_toolbar": false
            });
            console.log(`TradingView: Widget cr√©√© pour ${tvSymbol}`);
        }

        /**
         * Ouvre une connexion WebSocket pour obtenir les prix en direct de Binance.
         */
        function startWebSocket(symbol) {
            // 1. Fermer la connexion pr√©c√©dente si elle existe
            if (currentWebSocket) {
                currentWebSocket.close(1000, "Nouveau symbole charg√©."); // Code 1000: fermeture normale
                currentWebSocket = null;
            }
            
            // Assurez-vous que le prix est remis √† z√©ro pendant la connexion
            currentPrice = 0;
            
            // Binance utilise des symboles en minuscules pour les WebSockets
            const wsSymbol = symbol.toLowerCase().replace('binance:', '');
            
            if (wsSymbol.length < 5) {
                 document.getElementById('display-current-price').innerText = `Symbole court invalide (${symbol}). Tentez BTCUSDT.`;
                 return;
            }

            // 2. Cr√©er la nouvelle connexion
            const wsURL = `wss://stream.binance.com:9443/ws/${wsSymbol}@trade`; 
            
            console.log(`Tentative de connexion WebSocket √†: ${wsURL}`); // LOG DE D√âBOGAGE
            
            currentWebSocket = new WebSocket(wsURL);
            currentWebSocket.symbol = symbol; 

            document.getElementById('display-current-price').innerText = '... Connexion ...';

            // 3. Gestion des messages (Nouveau prix re√ßu)
            currentWebSocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                // V√©rifier si le message est une donn√©e de trade
                if (data && data.p) { 
                    const latestPrice = parseFloat(data.p);
                    
                    if (!isNaN(latestPrice)) {
                        currentPrice = latestPrice;
                        // Mettre √† jour avec une gestion du format (ex: si le prix est tr√®s petit)
                        const precision = latestPrice > 1 ? 2 : 4; 
                        document.getElementById('display-current-price').innerText = currentPrice.toFixed(precision) + ' $';
                        
                        updateFloatingPnlUI(); // Mettre √† jour l'UI P&L avec le nouveau prix
                    }
                } else if (data && data.e === 'error') {
                     // Binance envoie parfois une erreur si le symbole n'existe pas
                     console.error("Erreur re√ßue de Binance:", data);
                     currentWebSocket.close(1000, "Symbole non trouv√© par Binance.");
                }
            };

            // 4. Gestion des √©v√©nements de connexion
            currentWebSocket.onopen = () => {
                console.log(`WebSocket connect√© pour ${symbol}. Attente du premier prix...`);
            };

            currentWebSocket.onerror = (error) => {
                console.error(`Erreur WebSocket (g√©n√©rique) pour ${symbol}:`, error);
                document.getElementById('display-current-price').innerText = `[ERREUR] Impossible de se connecter au serveur.`;
            };
            
            currentWebSocket.onclose = (event) => {
                console.log(`WebSocket d√©connect√© pour ${symbol}. Code: ${event.code}. Raison: ${event.reason}`);
                // Code 1006 est un √©chec de connexion (symbole inconnu, bloqu√©, ou fermeture anormale)
                if (event.code === 1006 || event.reason.includes('non trouv√©')) {
                    document.getElementById('display-current-price').innerText = `[√âCHEC] Symbole (${symbol}) non trouv√© sur Binance.`;
                } else if (event.code !== 1000) {
                     document.getElementById('display-current-price').innerText = `D√©connect√© (${event.code}). V√©rifiez la console.`;
                }
            };
        }
        
        // G√®re le chargement d'un nouveau symbole
        function loadNewSymbol(newSymbol) {
            currentSymbol = newSymbol.replace('BINANCE:', ''); 
            localStorage.setItem('lastSymbol', currentSymbol);
            const theme = document.documentElement.getAttribute('data-theme');
            
            startWebSocket(currentSymbol); // D√©marre la lecture du prix en temps r√©el (le plus critique)
            
            // Rechargement du widget TradingView
            setTimeout(() => {
                initWidget(theme, currentSymbol); 
            }, 50); 
        }


        document.getElementById('load-symbol-btn').addEventListener('click', () => {
            const val = document.getElementById('symbol-input').value.toUpperCase();
            if(val) {
                loadNewSymbol(val); 
            }
        });

        // --- SIMULATEUR DE TRADING (Ajout des fonctions de r√©initialisation) ---
        // Le montant par d√©faut pour la r√©initialisation est 10000.
        const defaultSimData = { balance: 10000, positions: [] };
        let simData = JSON.parse(localStorage.getItem('tradeLingoSim')) || defaultSimData;

        function updateSimUI() {
            // Utilise 'fr-FR' pour le formatage mon√©taire
            document.getElementById('sim-balance').innerText = simData.balance.toLocaleString('fr-FR', { style: 'currency', currency: 'USD' });
            updateFloatingPnlUI(); 
        }

        /**
         * Met √† jour le P&L flottant pour toutes les positions.
         * N'utilise le prix en temps r√©el que pour le symbole ACTUELLEMENT CHARG√â.
         */
        function updateFloatingPnlUI() {
            const tbody = document.getElementById('positions-body');
            tbody.innerHTML = '';

            if (simData.positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--text-secondary);">Aucune position ouverte</td></tr>';
                return;
            }
            
            simData.positions.forEach((pos, index) => {
                let pnlAmount = 0;
                let pnlPercent = 0;
                let pnlText = 'N/A';
                let pnlDisplayClass = '';
                
                // V√âRIFICATION CRITIQUE: On calcule le P&L flottant UNIQUEMENT
                // si la position correspond au symbole actuellement suivi (currentSymbol)
                // et si le prix (currentPrice) est bien charg√©.
                if (pos.symbol === currentSymbol && currentPrice !== 0) {
                    const priceToUse = currentPrice;
                    
                    if (pos.type === 'buy') {
                        // LONG: (Prix Sortie - Prix Entr√©e) / Prix Entr√©e
                        pnlPercent = (priceToUse - pos.entryPrice) / pos.entryPrice;
                    } else { 
                        // SHORT: (Prix Entr√©e - Prix Sortie) / Prix Entr√©e
                        pnlPercent = (pos.entryPrice - priceToUse) / pos.entryPrice;
                    }
                    
                    pnlAmount = pos.size * pnlPercent;

                    pnlDisplayClass = pnlAmount >= 0 ? 'pl-green' : 'pl-red';
                    pnlText = pnlAmount.toFixed(2) + ' $ (' + (pnlPercent * 100).toFixed(2) + '%)';
                } else {
                    // Si le symbole ne correspond pas, affiche un message d'information.
                    const infoText = (pos.symbol === currentSymbol) 
                        ? 'Prix en attente...' 
                        : `(${pos.symbol}) Prix non suivi`;

                    pnlText = `<span style="color:var(--text-secondary); font-weight:normal;">${infoText}</span>`;
                    pnlDisplayClass = '';
                }


                const row = document.createElement('tr');
                const typeColor = pos.type === 'buy' ? 'var(--green)' : 'var(--red)';
                const typeLabel = pos.type === 'buy' ? 'LONG üü¢' : 'SHORT üî¥';
                
                row.innerHTML = `
                    <td style="font-weight:bold;">${pos.symbol}</td>
                    <td style="color:${typeColor}; font-weight:bold;">${typeLabel}</td>
                    <td>${pos.entryPrice.toFixed(2)} $</td>
                    <td class="${pnlDisplayClass}">${pnlText}</td> 
                    <td>${pos.size.toFixed(2)} $</td>
                    <td>
                        <button class="action-btn btn-blue btn-small" onclick="closePositionPrompt(${index})">Cl√¥turer</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function executeTrade(type) {
            const amountInput = document.getElementById('trade-amount');
            const amount = parseFloat(amountInput.value);
            
            if (currentPrice === 0) {
                 // Remplacer l'alert() par une boite de message custom ou une mise √† jour d'UI si l'environnement le permet.
                 // Pour rester simple ici, j'utilise alert() car la modification est minimale.
                 alert("Le prix actuel n'est pas encore charg√©. Veuillez patienter ou v√©rifier si le symbole est valide (ex: BTCUSDT).");
                 return;
            }

            if (!amount || amount <= 0) {
                alert("Veuillez entrer un montant valide.");
                return;
            }
            if (amount > simData.balance * 2) { 
                alert("Taille de position trop grande. Investissez moins.");
                return;
            }
            
            const newPosition = {
                symbol: currentSymbol,
                type: type, 
                entryPrice: currentPrice, 
                size: amount,
                timestamp: new Date().toISOString()
            };

            simData.positions.push(newPosition);
            saveSimData();
            
            amountInput.value = '';
            
            updateSimUI();
            alert(`Ordre ${type.toUpperCase()} de ${amount.toFixed(2)}$ ex√©cut√© √† ${currentPrice.toFixed(2)}$.`);
        }

        function closePositionPrompt(index) {
            const pos = simData.positions[index];
            
            // Utiliser le prix actuel si la position correspond au symbole suivi, sinon utiliser le prix d'entr√©e par d√©faut
            const defaultPrice = (pos.symbol === currentSymbol && currentPrice !== 0) 
                ? currentPrice.toFixed(2) 
                : pos.entryPrice.toFixed(2); // Option de repli si le prix n'est pas suivi

            const currentPriceStr = prompt(`Fermeture de ${pos.symbol} (${pos.type.toUpperCase()}).\nEntr√©e : ${pos.entryPrice.toFixed(2)} $\n\nEntrez le prix de CL√îTURE (Prix actuel du suivi : ${defaultPrice} $) :`, defaultPrice);
            
            if (currentPriceStr) {
                const exitPrice = parseFloat(currentPriceStr);
                if (isNaN(exitPrice)) { alert("Prix invalide"); return; }
                
                closePosition(index, exitPrice);
            }
        }

        function closePosition(index, exitPrice) {
            const pos = simData.positions[index];
            let pnlPercent = 0;
            
            if (pos.type === 'buy') {
                pnlPercent = (exitPrice - pos.entryPrice) / pos.entryPrice;
            } else {
                pnlPercent = (pos.entryPrice - exitPrice) / pos.entryPrice;
            }
            
            const pnlAmount = pos.size * pnlPercent;
            simData.balance += pnlAmount; 
            
            simData.positions.splice(index, 1);
            saveSimData();
            updateSimUI();
            
            const msg = pnlAmount >= 0 ? "Gagn√© ! ü§ë" : "Perdu... üìâ";
            alert(`${msg}\nR√©sultat : ${pnlAmount.toFixed(2)} $`);
        }

        function saveSimData() {
            localStorage.setItem('tradeLingoSim', JSON.stringify(simData));
        }

        /**
         * Demande √† l'utilisateur un montant et r√©initialise le simulateur.
         */
        function resetSimulatorPrompt() {
            // Le montant par d√©faut (10000$) est d√©fini dans defaultSimData
            const defaultResetAmount = defaultSimData.balance; 
            
            // Utilisation d'un prompt pour demander le nouveau montant
            const newBalanceStr = prompt(
                `Veuillez entrer le nouveau capital pour la r√©initialisation :\n(Laisser vide pour la valeur par d√©faut : ${defaultResetAmount} $).`, 
                defaultResetAmount
            );

            if (newBalanceStr !== null) { // V√©rifie si l'utilisateur n'a pas annul√©
                let newBalance = parseFloat(newBalanceStr);
                
                // Si l'entr√©e est vide ou non un nombre valide, utilise le montant par d√©faut
                if (isNaN(newBalance) || newBalance <= 0) {
                     newBalance = defaultResetAmount;
                }
                
                resetSimulator(newBalance);
            }
        }
        
        /**
         * R√©initialise le simulateur au solde sp√©cifi√© et ferme les positions.
         */
        function resetSimulator(amount) {
            // Remplacer le confirm() par une boite de message custom ou une mise √† jour d'UI si l'environnement le permet.
            if (!confirm(`√ätes-vous s√ªr de vouloir r√©initialiser le compte √† ${amount.toLocaleString('fr-FR', { style: 'currency', currency: 'USD' })} ?\nToutes les positions ouvertes seront ferm√©es sans P&L calcul√©.`)) {
                return;
            }
            
            // 1. R√©initialiser les donn√©es
            simData.balance = amount;
            simData.positions = []; // Ferme toutes les positions ouvertes
            
            // 2. Sauvegarder
            saveSimData();
            
            // 3. Mettre √† jour l'interface utilisateur
            updateSimUI();
            
            alert(`Compte de simulation r√©initialis√© √† ${amount.toLocaleString('fr-FR', { style: 'currency', currency: 'USD' })}.`);
        }


        // --- THEME & INITIALISATION ---
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const target = current === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', target);
            localStorage.setItem('themeMode', target === 'dark' ? 'dark-mode' : 'light-mode');
            
            // Recharger le widget avec un l√©ger d√©lai
            setTimeout(() => {
                initWidget(target, currentSymbol);
            }, 50);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Charger Th√®me
            const savedMode = localStorage.getItem('themeMode') || 'light-mode';
            const themeAttr = savedMode === 'dark-mode' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', themeAttr);
            
            // 2. Charger Stats
            updateStatsUI();
            
            // 3. Charger Widget & D√©marrer le WebSocket
            currentSymbol = currentSymbol.replace('BINANCE:', ''); 
            document.getElementById('symbol-input').value = currentSymbol;
            
            initWidget(themeAttr, currentSymbol);
            startWebSocket(currentSymbol); 

            // 4. Charger Sim
            updateSimUI();
        });

    </script>
</body>
</html>
